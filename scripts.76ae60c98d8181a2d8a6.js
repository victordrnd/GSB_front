import DEFAULTS from"./defaults";import TEMPLATE from"./template";import render from"./render";import events from"./events";import handlers from"./handlers";import methods from"./methods";import others from"./others";import{BUTTONS,CLASS_CLOSE,CLASS_FADE,CLASS_FIXED,CLASS_FULLSCREEN,CLASS_HIDE,CLASS_INVISIBLE,DATA_ACTION,EVENT_CLICK,EVENT_LOAD,EVENT_READY,NAMESPACE,REGEXP_SPACES,WINDOW}from"./constants";import{addClass,addListener,assign,dispatchEvent,forEach,getResponsiveClass,hyphenate,isFunction,isNumber,isPlainObject,isString,isUndefined,removeListener,setData,setStyle,toggleClass}from"./utilities";const AnotherViewer=WINDOW.Viewer;class Viewer{constructor(e,t={}){if(!e||1!==e.nodeType)throw new Error("The first argument is required and must be an element.");this.element=e,this.options=assign({},DEFAULTS,isPlainObject(t)&&t),this.action=!1,this.fading=!1,this.fulled=!1,this.hiding=!1,this.imageClicked=!1,this.imageData={},this.index=this.options.initialViewIndex,this.isImg=!1,this.isShown=!1,this.length=0,this.played=!1,this.playing=!1,this.pointers={},this.ready=!1,this.showing=!1,this.timeout=!1,this.tooltipping=!1,this.viewed=!1,this.viewing=!1,this.wheeling=!1,this.zooming=!1,this.init()}init(){const{element:e,options:t}=this;if(e[NAMESPACE])return;e[NAMESPACE]=this;const i="img"===e.tagName.toLowerCase(),s=[];forEach(i?[e]:e.querySelectorAll("img"),e=>{isFunction(t.filter)?t.filter.call(this,e)&&s.push(e):s.push(e)}),this.isImg=i,this.length=s.length,this.images=s;const{ownerDocument:n}=e,a=n.body||n.documentElement;if(this.body=a,this.scrollbarWidth=window.innerWidth-n.documentElement.clientWidth,this.initialBodyPaddingRight=window.getComputedStyle(a).paddingRight,isUndefined(document.createElement(NAMESPACE).style.transition)&&(t.transition=!1),t.inline){let e=0;const t=()=>{if(e+=1,e===this.length){let e;this.initializing=!1,this.delaying={abort:()=>{clearTimeout(e)}},e=setTimeout(()=>{this.delaying=!1,this.build()},0)}};this.initializing={abort(){forEach(s,e=>{e.complete||removeListener(e,EVENT_LOAD,t)})}},forEach(s,e=>{e.complete?t():addListener(e,EVENT_LOAD,t,{once:!0})})}else addListener(e,EVENT_CLICK,this.onStart=({target:e})=>{"img"!==e.tagName.toLowerCase()||isFunction(t.filter)&&!t.filter.call(this,e)||this.view(this.images.indexOf(e))})}build(){if(this.ready)return;const{element:e,options:t}=this,i=e.parentNode,s=document.createElement("div");s.innerHTML=TEMPLATE;const n=s.querySelector(`.${NAMESPACE}-container`),a=n.querySelector(`.${NAMESPACE}-title`),o=n.querySelector(`.${NAMESPACE}-toolbar`),r=n.querySelector(`.${NAMESPACE}-navbar`),l=n.querySelector(`.${NAMESPACE}-button`),d=n.querySelector(`.${NAMESPACE}-canvas`);if(this.parent=i,this.viewer=n,this.title=a,this.toolbar=o,this.navbar=r,this.button=l,this.canvas=d,this.footer=n.querySelector(`.${NAMESPACE}-footer`),this.tooltipBox=n.querySelector(`.${NAMESPACE}-tooltip`),this.player=n.querySelector(`.${NAMESPACE}-player`),this.list=n.querySelector(`.${NAMESPACE}-list`),addClass(a,t.title?getResponsiveClass(Array.isArray(t.title)?t.title[0]:t.title):CLASS_HIDE),addClass(r,t.navbar?getResponsiveClass(t.navbar):CLASS_HIDE),toggleClass(l,CLASS_HIDE,!t.button),t.backdrop&&(addClass(n,`${NAMESPACE}-backdrop`),t.inline||"static"===t.backdrop||setData(d,DATA_ACTION,"hide")),isString(t.className)&&t.className&&t.className.split(REGEXP_SPACES).forEach(e=>{addClass(n,e)}),t.toolbar){const e=document.createElement("ul"),i=isPlainObject(t.toolbar),s=BUTTONS.slice(0,3),n=BUTTONS.slice(7,9),a=BUTTONS.slice(9);i||addClass(o,getResponsiveClass(t.toolbar)),forEach(i?t.toolbar:BUTTONS,(o,r)=>{const l=i&&isPlainObject(o),d=i?hyphenate(r):o,h=l&&!isUndefined(o.show)?o.show:o;if(!h||!t.zoomable&&-1!==s.indexOf(d)||!t.rotatable&&-1!==n.indexOf(d)||!t.scalable&&-1!==a.indexOf(d))return;const E=l&&!isUndefined(o.size)?o.size:o,c=l&&!isUndefined(o.click)?o.click:o,S=document.createElement("li");S.setAttribute("role","button"),addClass(S,`${NAMESPACE}-${d}`),isFunction(c)||setData(S,DATA_ACTION,d),isNumber(h)&&addClass(S,getResponsiveClass(h)),-1!==["small","large"].indexOf(E)?addClass(S,`${NAMESPACE}-${E}`):"play"===d&&addClass(S,`${NAMESPACE}-large`),isFunction(c)&&addListener(S,EVENT_CLICK,c),e.appendChild(S)}),o.appendChild(e)}else addClass(o,CLASS_HIDE);if(!t.rotatable){const e=o.querySelectorAll('li[class*="rotate"]');addClass(e,CLASS_INVISIBLE),forEach(e,e=>{o.appendChild(e)})}if(t.inline)addClass(l,CLASS_FULLSCREEN),setStyle(n,{zIndex:t.zIndexInline}),"static"===window.getComputedStyle(i).position&&setStyle(i,{position:"relative"}),i.insertBefore(n,e.nextSibling);else{addClass(l,CLASS_CLOSE),addClass(n,CLASS_FIXED),addClass(n,CLASS_FADE),addClass(n,CLASS_HIDE),setStyle(n,{zIndex:t.zIndex});let{container:i}=t;isString(i)&&(i=e.ownerDocument.querySelector(i)),i||(i=this.body),i.appendChild(n)}t.inline&&(this.render(),this.bind(),this.isShown=!0),this.ready=!0,isFunction(t.ready)&&addListener(e,EVENT_READY,t.ready,{once:!0}),!1!==dispatchEvent(e,EVENT_READY)?this.ready&&t.inline&&this.view(this.index):this.ready=!1}static noConflict(){return window.Viewer=AnotherViewer,Viewer}static setDefaults(e){assign(DEFAULTS,isPlainObject(e)&&e)}}assign(Viewer.prototype,render,events,handlers,methods,others);export default Viewer;